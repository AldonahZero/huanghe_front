# 项目详情页面 - 技术架构图

## 📐 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                       用户浏览器 (Browser)                         │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            │ HTTP Request
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│                    Next.js App Router                            │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  /dashboard                                              │  │
│  │  └─ page.tsx (仪表盘)                                     │  │
│  │     └─ ItemCard.tsx (可点击卡片) ───┐                    │  │
│  └──────────────────────────────────────│───────────────────┘  │
│                                          │                       │
│  ┌──────────────────────────────────────▼───────────────────┐  │
│  │  /dashboard/project/[id]                                 │  │
│  │  └─ page.tsx (项目详情主页面)                             │  │
│  │     │                                                     │  │
│  │     ├─ TimeRangeSelector ─────────┐                      │  │
│  │     │                              │                      │  │
│  │     ├─ BuyOrdersSection           │                      │  │
│  │     │  ├─ 前30名求购者列表          │                      │  │
│  │     │  └─ 位次分布可视化           │                      │  │
│  │     │                              │                      │  │
│  │     ├─ SellListingsSection        │ onChange(hours)     │  │
│  │     │  └─ 前30名挂售者列表          │                      │  │
│  │     │                              │                      │  │
│  │     └─ TransactionsSection ◄──────┘                      │  │
│  │        ├─ Tab: 买入排行                                   │  │
│  │        ├─ Tab: 卖出排行                                   │  │
│  │        └─ Tab: 交易关系                                   │  │
│  └──────────────────────────────────────────────────────────┘  │
│                            │                                    │
│                            │ getData(projectId, timeRange)     │
│                            │                                    │
│  ┌────────────────────────▼─────────────────────────────────┐  │
│  │  lib/projectAnalysis.ts                                  │  │
│  │  ├─ generateMockProjectData(projectId)                   │  │
│  │  │  └─ generateHourlyData(hours) ──┐                     │  │
│  │  │                                  │                     │  │
│  │  └─ analyzeProjectData(hourlyData, timeRange)            │  │
│  │     │                               │                     │  │
│  │     ├─ 分析求购数据 ◄────────────────┘                     │  │
│  │     │  ├─ 聚合求购订单                                     │  │
│  │     │  └─ 计算位次分布                                     │  │
│  │     │                                                     │  │
│  │     ├─ 分析在售数据                                        │  │
│  │     │  └─ 聚合挂售列表                                     │  │
│  │     │                                                     │  │
│  │     └─ 分析成交数据                                        │  │
│  │        ├─ 统计买入次数                                     │  │
│  │        ├─ 统计卖出次数                                     │  │
│  │        └─ 计算交易对关系                                   │  │
│  └──────────────────────────────────────────────────────────┘  │
│                            │                                    │
│                            │ types                              │
│                            │                                    │
│  ┌────────────────────────▼─────────────────────────────────┐  │
│  │  types/project.ts                                        │  │
│  │  ├─ UserProfile                                          │  │
│  │  ├─ BuyOrder                                             │  │
│  │  ├─ SellListing                                          │  │
│  │  ├─ Transaction                                          │  │
│  │  ├─ PositionDistribution                                 │  │
│  │  ├─ UserTransactionStats                                 │  │
│  │  ├─ UserPairTransaction                                  │  │
│  │  ├─ HourlyData                                           │  │
│  │  └─ AnalysisResult                                       │  │
│  └──────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────┘
```

## 🔄 数据流转

### 1. 用户交互流程

```
用户点击仪表盘卡片
        │
        ▼
ItemCard.onClick()
        │
        ▼
router.push(`/dashboard/project/${item.id}`)
        │
        ▼
Next.js 路由跳转
        │
        ▼
ProjectDetailPage 组件挂载
        │
        ▼
useEffect 触发数据加载
        │
        ▼
generateMockProjectData(projectId)
        │
        ├─ 生成72小时模拟数据
        │  └─ 每小时: 30个求购 + 30个在售 + 20-70个成交
        │
        ▼
analyzeProjectData(hourlyData, 24h)
        │
        ├─ 分析求购数据
        ├─ 分析在售数据
        └─ 分析成交数据
        │
        ▼
setAnalysisResult(result)
        │
        ▼
组件重新渲染,展示分析结果
```

### 2. 时间范围变化流程

```
用户点击时间选择器按钮
        │
        ▼
TimeRangeSelector.onChange(newHours)
        │
        ▼
setTimeRange(newHours)
        │
        ▼
useEffect [timeRange] 触发
        │
        ▼
analyzeProjectData(hourlyData, newHours)
        │
        ▼
更新分析结果
        │
        ▼
所有子组件重新渲染
```

### 3. 用户选择流程 (求购位次分布)

```
用户点击求购者卡片
        │
        ▼
BuyOrdersSection.setSelectedUser(userId)
        │
        ▼
组件状态更新
        │
        ▼
根据 selectedUser 过滤 positionDistribution
        │
        ▼
展示选中用户的位次分布详情
```

## 🗂️ 文件组织结构

```
huanghe_front/
│
├── app/
│   └── dashboard/
│       ├── page.tsx                    # 仪表盘页面
│       └── project/
│           └── [id]/
│               └── page.tsx            # 项目详情页面 ★
│
├── components/
│   ├── ItemCard.tsx                    # 饰品卡片 (修改)
│   ├── BuyOrdersSection.tsx            # 求购数据组件 ★
│   ├── SellListingsSection.tsx         # 在售数据组件 ★
│   ├── TransactionsSection.tsx         # 成交分析组件 ★
│   └── TimeRangeSelector.tsx           # 时间选择器 ★
│
├── lib/
│   └── projectAnalysis.ts              # 数据分析逻辑 ★
│
├── types/
│   └── project.ts                      # TypeScript类型 ★
│
└── task/
    ├── 项目详情页面功能文档.md          # 完整文档 ★
    ├── 快速开始指南.md                 # 使用指南 ★
    └── 实现总结.md                     # 总结文档 ★

★ = 本次新增/修改的文件
```

## 🔢 数据处理算法

### 算法 1: 求购位次分布计算

```typescript
输入: 
  - hourlyData: HourlyData[]
  - timeRange: number (小时)

处理步骤:
1. 过滤时间范围内的数据
   filteredData = hourlyData.filter(d => d.timestamp >= cutoffTime)

2. 遍历所有求购订单,记录位次
   for each hour in filteredData:
     for each order in hour.buyOrders:
       positionMap[order.userId].push(order.position)

3. 统计每个位次出现的次数
   for each userId in positionMap:
     for each position in positionMap[userId]:
       positionCounts[position]++

4. 计算百分比
   percentage = (count / totalOrders) * 100

输出:
  - PositionDistribution[]
```

### 算法 2: 交易对关系计算

```typescript
输入:
  - transactions: Transaction[]

处理步骤:
1. 创建交易对映射
   pairKey = sort([buyerId, sellerId]).join(":")
   pairMap[pairKey] = []

2. 记录每笔交易
   for each transaction in transactions:
     pairMap[pairKey].push({
       buyer: transaction.buyerId,
       seller: transaction.sellerId
     })

3. 分别统计双向交易
   for each pair in pairMap:
     count user1 bought from user2
     count user2 bought from user1

4. 筛选活跃交易对
   activePairs = pairs.filter(p => p.totalTransactions >= 3)

5. 按总交易次数排序
   activePairs.sort((a, b) => b.totalTransactions - a.totalTransactions)

输出:
  - UserPairTransaction[]
```

### 算法 3: 用户聚合统计

```typescript
输入:
  - hourlyData: HourlyData[]
  - type: 'buy' | 'sell'

处理步骤:
1. 创建用户映射
   userMap = new Map<string, number>()

2. 遍历所有数据累加
   for each hour in hourlyData:
     for each order/listing:
       userMap[userId] = (userMap[userId] || 0) + count

3. 转换为数组并排序
   users = Array.from(userMap.entries())
   users.sort((a, b) => b.count - a.count)

4. 取前N名
   topUsers = users.slice(0, limit)

输出:
  - User[] (排序后)
```

## 🎨 组件交互关系

```
ProjectDetailPage (主页面)
│
├─ state: timeRange
├─ state: analysisResult
├─ state: projectData
│
├── TimeRangeSelector
│   │
│   ├─ props: value, onChange
│   └─ event: onChange(newHours) → setTimeRange
│
├── 数据统计卡片 (3个)
│   ├─ 求购总数
│   ├─ 挂售总数
│   └─ 成交总数
│
├── BuyOrdersSection
│   │
│   ├─ props: topBuyers, positionDistribution
│   ├─ state: selectedUser
│   │
│   ├── 求购者列表
│   │   └─ onClick → setSelectedUser
│   │
│   └── 位次分布展示
│       └─ 根据 selectedUser 过滤数据
│
├── SellListingsSection
│   │
│   └─ props: topSellers
│       └── 挂售者列表
│
└── TransactionsSection
    │
    ├─ props: topBuyers, topSellers, activePairs
    ├─ state: activeTab
    │
    ├── Tab 按钮组
    │   └─ onClick → setActiveTab
    │
    ├── 买入排行 (activeTab === 'buyers')
    ├── 卖出排行 (activeTab === 'sellers')
    └── 交易关系 (activeTab === 'pairs')
```

## 🔐 数据完整性保证

### userId 唯一性
```
所有数据关联都基于 userId (永久不变)
userName 只用于显示,不用于数据关联
avatarUrl 默认值: '/logo.ico'
```

### 时间戳一致性
```
所有时间戳使用 Unix timestamp (毫秒)
时间范围过滤: timestamp >= (now - hours * 3600 * 1000)
数据按时间戳排序
```

### 数据聚合规则
```
同一用户在不同时间点的数据累加
交易对使用排序后的 userId 组合作为键
位次记录保留所有历史值
```

## 🚀 性能优化策略

### 当前实现
```
✓ Map 数据结构 (O(1) 查找)
✓ 单次遍历聚合
✓ 按需计算 (时间范围变化时)
✓ 组件级状态管理
```

### 可优化点
```
→ 使用 useMemo 缓存计算结果
→ 使用 useCallback 缓存回调函数
→ 虚拟滚动长列表
→ Web Worker 处理大数据
→ 数据分页加载
```

## 📊 数据量估算

```
假设条件:
- 72小时历史数据
- 每小时30个求购 + 30个在售 + 50个成交

数据量:
- 求购数据: 72 × 30 = 2,160 条
- 在售数据: 72 × 30 = 2,160 条
- 成交数据: 72 × 50 = 3,600 条
- 总计: 7,920 条记录

内存占用:
- 每条记录约 200 bytes
- 总内存: ~1.5 MB

处理时间:
- 聚合计算: < 100ms
- 渲染时间: < 50ms
- 总响应时间: < 200ms
```

---

**架构设计原则**: 
- ✅ 职责分离 (组件 / 逻辑 / 类型)
- ✅ 数据驱动
- ✅ 可扩展性
- ✅ 类型安全
